<script src="//codecloud.cdn.speedyrails.net/sites/5438407c6e6f64462d020000/92b82a88144a6207ab1a5e8e0f63d3d1/craftmap.js"></script>
<div class="main_banner text-center">
    <h3>Shop & Entertainment</h3>
    <p>explore • enjoy • shop</p>
</div>
<div class="store_list_head main_container">
    <div class="row hidden_phone">
        <div class="col-md-4">
            <h5 class="active_heading">Shopping & Services</h5>
        </div>
        <div class="col-md-4">
            <h5><a href="/restaurants">Restaurants</a></h5>
        </div>
        <div class="col-md-4">
            <h5><a href="/map">Centre Map</a></h5>
        </div>
    </div>
    <h5 class="text-center tap_here show_phone">
        <label for="option_selector">More Options</label>
        <select title="Form" id="option_selector" class="link_selector">
            <option title="More Options" value="" disabled selected>TAP FOR MORE OPTIONS</option>
            <option title="Restaurants" value="/restaurants">Restaurants</option>
            <option title="Centre Map" value="/map">Centre Map</option>
        </select>
    </h5>
</div>
<div class="store_category_selector show_phone" >
    <h5 class="text-center tap_here">SELECT CATEGORY
    </h5>
</div>
<div class="hidden_now margin_25_across" id="category_selector_container">
    <script id="category_selector_template" type="x-tmpl-mustache/text">
        <p class="mobile_cat" cat_id="{{id}}">{{name}}</p>
    </script>
</div>
<div class="padded_border"></div>
<div class="content_container main_container position_relative">
    <div class="margin_25_across">
        <div class="row">
            <div class="col-md-8">
                <h5 class="category_header" style="display:none" id="cat_name_header">All</h5>
                <div class="row main_row">
                    <div class="col-md-6">
                        <div class="" id="store_list_container">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="" id="store_list_container2">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 hidden_phone">
                <div id="holiday_stores" class="hidden_now">
                    <p class="category_header holiday_header">Holiday Stores</p>
                    <div id="holiday_store_container">
                        <script id="holiday_store_template" type="x-tmpl-mustache/text">
                            <h5 class="category_name"><a href="/stores/{{slug}}">{{name}}</a></h5>    
                        </script>
                    </div>
                </div>
                <div id="new_stores">
                    <p class="category_header">New Stores</p>
                    <div id="new_store_container">
                        <script id="new_store_template" type="x-tmpl-mustache/text">
                            <h5 class="category_name"><a href="/stores/{{slug}}">{{name}}</a></h5>    
                        </script>
                    </div>
                </div>
                <div id="coming_soon_stores">
                    <p class="category_header">Opening Soon</p>
                    <div id="coming_soon_container">
                        <script id="coming_soon_template" type="x-tmpl-mustache/text">
                            <h5 class="category_name"><a href="/stores/{{slug}}">{{name}}</a></h5>    
                        </script>
                    </div>
                </div>
                <p class="category_header">Categories</p>
                <h5 class="category_name active_cat hidden_phone"><a href="#" class="show_all_stores">All</a></h5>
                <div id="category_container" class="hidden_phone">
                    <script id="category_template" type="x-tmpl-mustache/text">
                        <h5 class="category_name"><a href="#" class="show_cat_stores" data-id="{{id}}">{{name}}</a></h5>    
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<script id="store_list_template" type="x-tmpl-mustache/text">
    <div class="store_list_content cats_row" data-cat="{{cat_list}}">
        <p class="store_initial" style="{{show}}" id="{{initial}}">{{initial}}</p>
        <p class="store_name">
            <a href="/stores/{{slug}}">{{name}}</a><span class="coming_soon_store" style="{{coming_soon}}">- Opening Soon</span>
        </p>
    </div>
</script>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll (){
            var stores = getStoresList(); 
            renderStoreList('#store_list_container','#store_list_template', stores, "A", "L");
            renderStoreList('#store_list_container2','#store_list_template', stores, "M", "Z");
            renderStoreList('#store_list_container_map','#store_list_template_map', stores, "A", "Z");
            
            var categories = getStoreCategories();
            renderGeneral('#category_container', '#category_template', categories);
            var mobile_cat_list = categories;
            var all_cat = {};
            all_cat.name = "All Categories";
            all_cat.id= 0;
            mobile_cat_list.unshift(all_cat);
            renderGeneral('#category_selector_container', '#category_selector_template', mobile_cat_list);
            
            $(".store_category_selector").click(function(e){
                $("#category_selector_container").slideToggle();
                $(".padded_border").toggle()
            })
            $(".mobile_cat").click(function(e){
                cat_id = $(this).attr('cat_id');
                show_mobile_cat_stores(cat_id, $(this));
                 $("#category_selector_container").slideToggle();
                 $(".padded_border").toggle()
            })
            
            show_cat_stores();
            
            var holiday_stores = [];
            $.each(stores, function(key, val){
                if(val.tags != null) {
                    var store_tags = val.tags.join(",");
                    if(store_tags.indexOf('holiday') > -1){
                        holiday_stores.push(val);
                    }
                }
            });
            if(holiday_stores.length > 0){
                renderGeneral("#holiday_store_container","#holiday_store_template", holiday_stores);
                $("#holiday_stores").show();
            }
            
            var new_stores = getNewStoresList();
            if (new_stores.length > 0){
                renderGeneral("#new_store_container","#new_store_template", new_stores);
            } else {
                $('#new_stores').hide();
            }
            
            var coming_soon_list = getComingSoonList();
            var coming_soon_stores = [];
            $.each(coming_soon_list, function(key, val){
                var today = moment().format("YYYY-MM-DD");
                if(val.new_store_open_date == null || val.new_store_open_date >= today){
                    coming_soon_stores.push(val);
                }
            });
            if (coming_soon_stores.length > 0){
                renderGeneral("#coming_soon_container","#coming_soon_template", coming_soon_stores);
            } else {
                $('#coming_soon_stores').hide();
            }
            
            show_content();
            $.each(stores, function(i, val){
                x = val.x_coordinate - 19;
                y = val.y_coordinate - 58;
                $('#map_image').after('<div class="marker" id="store_' + val.id  + '" data-coords="' + x + ', ' + y + '" style="display:none"><a style="color:#fff" href=/stores/'+val.slug +'>' + val.name + '</a></div>')
            });  
            
            $('#map').craftmap({
    		    image: {
    				width: 850,
    				height: 850,
    			},
    			map: {
    				position: 'center'
    			}
    		});
        }
        
		loadMallDataCached(renderAll); 
    })
    function show_mobile_cat_stores(cat_id, el){
        if(cat_id == 0){
            $('.main_row .col-md-6').removeClass('full_width')
            $('#no_promo_in_category').hide();
            $('.active_cat').removeClass('active_cat');
            el.addClass('active_cat');
            var rows = $('.cats_row');
            rows.show();
            $.each($('.store_initial'), function(i, val){
               if ($(val).text().length > 0){
                   $(val).show();
               } 
            });
            $('#cat_name_header').hide();
        } else {
            $('.main_row .col-md-6').addClass('full_width')
            var visible_row = 0
            $('.active_cat').removeClass('active_cat');
            el.addClass('active_cat');
            var rows = $('.cats_row');
            rows.hide();
            $('#no_promo_in_category').hide();
            $('.store_initial').hide();
            $('#cat_name_header').text(el.text());
            $('#cat_name_header').css('display', 'block');
            $.each(rows, function(i, val){
                var cat_array = val.getAttribute('data-cat').split(',');
                if ($.inArray(cat_id, cat_array) >= 0){
                    $(val).show();
                    visible_row++;
                }
            });
            if(visible_row == 0){
                $('#no_promo_in_category').show();
            }
        }
    }
</script>